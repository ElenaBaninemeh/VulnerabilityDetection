from bs4 import BeautifulSoup
from urllib.request import urlopen
import json
from os import path

def GetCommand(Url, CVE):

 url = Url
 page = urlopen(url)
 html = page.read().decode("utf-8")
 soup = BeautifulSoup(html, "html.parser")

 data = []
 #td = soup.find('td', attrs={'class':'blob-num-deletion'})
 filename = './Command.json'

 # Get the attribute
 #attribute = td['data-line-number']

 UrlOfProject= url.split("/commit")

 # Print the output
 #print(attribute)

 details= []
 number=[]
 parentHash=[]

 for a in soup.findAll("a", attrs={"href":lambda value: value and value.startswith("#diff") , "class":"Link--primary"}):
     number.append(a.get('href'))

 length=len(number)

 for a in soup.findAll("a", attrs={"href":lambda value: value and value.startswith("#diff") , "class":"Link--primary"}):
     #print(a.get('href'))
     #print(a.get_text())
     #print(url+a.get('href'))


     length -= 1



     page2 = urlopen(url+a.get('href'))
     html2 = page2.read().decode("utf-8")
     soup2 = BeautifulSoup(html2, "html.parser")

     #print(a.get('href').rsplit('#', 1)[-1])

     #print("------")

     div= a.get('href').rsplit('#', 1)[-1]



     for n in soup2.find("div", {"id":div}).findAll('td', attrs={'class':'blob-num-deletion', "data-line-number":True}):
        data.append(n['data-line-number'])

     lines= str(','.join(data))
     #filedetails="<"+a.get_text()+":"+lines+"?"

     if lines== "":
         lines="0"


     if length == 0:
         filedetails=a.get_text()+":"+lines
         details += [filedetails]
     else:
         filedetails=a.get_text()+":"+lines+"?"
         details += [filedetails]


     #filedetails=details.append(test)



     #print(a.get_text(), *data, sep = ",")

     data.clear()
 command= str(''.join(details))


 for a in soup.findAll("a", attrs={"data-hotkey":"p" , "class":"sha"}):
     parentHash.append(a.get('href').rsplit('/', 1)[-1])

 commitHash= str(''.join(parentHash))
 #print(commitHash)

 #print(command)
 #print(CVE)

 MainCommand= "upload"+" "+ UrlOfProject[0]+" "+ "--code"+" "+CVE+" "+ "--commit" + " "+commitHash +" "+ "--lines" + " "+command
 print(MainCommand)

 # Read JSON file
 with open(filename) as fp:
     listObj = json.load(fp)
 listObj.append({
     "Command": MainCommand
      })

 # Verify updated list
 print(listObj)

 with open(filename, 'w') as json_file:
     json.dump(listObj, json_file,
               indent=4,
               separators=(',',': '))






